{% extends "base.html" %}

{% block title %}Admin Dashboard - VRChat World Showcase{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
    .stat-card {
        transition: all 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .placeholder-chart {
        background: rgba(88, 101, 242, 0.1);
        border-radius: 0.5rem;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #5865F2;
    }
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .badge-success {
        background-color: rgba(52, 211, 153, 0.1);
        color: rgb(52, 211, 153);
    }
    .badge-warning {
        background-color: rgba(251, 191, 36, 0.1);
        color: rgb(251, 191, 36);
    }
    .badge-danger {
        background-color: rgba(239, 68, 68, 0.1);
        color: rgb(239, 68, 68);
    }
    .badge-info {
        background-color: rgba(59, 130, 246, 0.1);
        color: rgb(59, 130, 246);
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-discord-dark text-white py-4">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl font-bold">Admin Dashboard</h1>
        <p class="text-gray-300">Manage your VRChat World Showcase Bot installation</p>
    </div>
</div>

<div class="container mx-auto px-4 py-6">
    <!-- Dashboard Tabs -->
    <div class="bg-white rounded-lg shadow-md mb-6">
        <div class="flex flex-wrap border-b" id="dashboardTabs">
            <button class="tab-btn px-6 py-3 font-medium text-discord-dark border-b-2 border-discord" data-tab="overview">
                <i class="fas fa-tachometer-alt mr-2"></i> Overview
            </button>
            <button class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-discord-dark" data-tab="servers">
                <i class="fas fa-server mr-2"></i> Servers
            </button>
            <button class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-discord-dark" data-tab="worlds">
                <i class="fas fa-globe mr-2"></i> Worlds
            </button>
            <button class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-discord-dark" data-tab="logs">
                <i class="fas fa-list mr-2"></i> Activity Logs
            </button>
            <button class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-discord-dark" data-tab="settings">
                <i class="fas fa-cog mr-2"></i> Settings
            </button>
        </div>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6 stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-600">Total Servers</h3>
                    <div class="text-2xl text-discord bg-discord bg-opacity-10 p-2 rounded-lg">
                        <i class="fas fa-server"></i>
                    </div>
                </div>
                <div class="text-3xl font-bold text-gray-800">{{ stats.server_count|default('0') }}</div>
                <div class="text-sm text-gray-500 mt-2">
                    <span class="text-green-500"><i class="fas fa-arrow-up"></i> {{ stats.server_growth|default('0') }}%</span> from last month
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-600">Active Forums</h3>
                    <div class="text-2xl text-green-500 bg-green-100 p-2 rounded-lg">
                        <i class="fas fa-comments"></i>
                    </div>
                </div>
                <div class="text-3xl font-bold text-gray-800">{{ stats.forum_count|default('0') }}</div>
                <div class="text-sm text-gray-500 mt-2">
                    <span class="text-green-500"><i class="fas fa-arrow-up"></i> {{ stats.forum_growth|default('0') }}%</span> from last month
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-600">Total Worlds</h3>
                    <div class="text-2xl text-yellow-500 bg-yellow-100 p-2 rounded-lg">
                        <i class="fas fa-globe"></i>
                    </div>
                </div>
                <div class="text-3xl font-bold text-gray-800">{{ stats.world_count|default('0') }}</div>
                <div class="text-sm text-gray-500 mt-2">
                    <span class="text-green-500"><i class="fas fa-arrow-up"></i> {{ stats.world_growth|default('0') }}%</span> from last month
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-600">Unique Users</h3>
                    <div class="text-2xl text-purple-500 bg-purple-100 p-2 rounded-lg">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="text-3xl font-bold text-gray-800">{{ stats.user_count|default('0') }}</div>
                <div class="text-sm text-gray-500 mt-2">
                    <span class="text-green-500"><i class="fas fa-arrow-up"></i> {{ stats.user_growth|default('0') }}%</span> from last month
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Server Growth</h3>
                <div class="chart-container">
                    <div class="placeholder-chart">
                        <div class="text-center">
                            <i class="fas fa-chart-line text-4xl mb-2"></i>
                            <p>Server growth chart will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4">World Categories</h3>
                <div class="chart-container">
                    <div class="placeholder-chart">
                        <div class="text-center">
                            <i class="fas fa-chart-pie text-4xl mb-2"></i>
                            <p>Category distribution chart will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-700">Recent Activity</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Server</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for activity in recent_activities|default([]) %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    {% if activity.guild.icon %}
                                    <img class="h-8 w-8 rounded-full mr-2" src="https://cdn.discordapp.com/icons/{{ activity.guild.id }}/{{ activity.guild.icon }}.png" alt="{{ activity.guild.name }}">
                                    {% else %}
                                    <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center mr-2">
                                        <span class="text-gray-600 font-bold">{{ activity.guild.name[:1] }}</span>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="font-medium text-gray-900">{{ activity.guild.name }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ activity.action }}</div>
                                <div class="text-sm text-gray-500">{{ activity.details }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if activity.status == 'success' %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check-circle mr-1"></i> Success
                                </span>
                                {% elif activity.status == 'warning' %}
                                <span class="badge badge-warning">
                                    <i class="fas fa-exclamation-circle mr-1"></i> Warning
                                </span>
                                {% elif activity.status == 'error' %}
                                <span class="badge badge-danger">
                                    <i class="fas fa-times-circle mr-1"></i> Error
                                </span>
                                {% else %}
                                <span class="badge badge-info">
                                    <i class="fas fa-info-circle mr-1"></i> Info
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ activity.timestamp }}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                                No recent activity to display
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t border-gray-200 text-right">
                <a href="#" class="text-discord hover:text-blue-700 font-medium">View All Activity <i class="fas fa-arrow-right ml-1"></i></a>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-700">System Status</h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="mb-4">
                            <span class="block text-sm font-medium text-gray-700 mb-1">API Status</span>
                            <div class="flex items-center">
                                <span class="badge badge-success mr-2">
                                    <i class="fas fa-check-circle mr-1"></i> Operational
                                </span>
                                <span class="text-sm text-gray-500">100% uptime in last 24h</span>
                            </div>
                        </div>
                        <div class="mb-4">
                            <span class="block text-sm font-medium text-gray-700 mb-1">Discord Bot Status</span>
                            <div class="flex items-center">
                                <span class="badge badge-success mr-2">
                                    <i class="fas fa-check-circle mr-1"></i> Online
                                </span>
                                <span class="text-sm text-gray-500">Connected to {{ stats.server_count|default('0') }} servers</span>
                            </div>
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-gray-700 mb-1">VRChat API Status</span>
                            <div class="flex items-center">
                                <span class="badge badge-success mr-2">
                                    <i class="fas fa-check-circle mr-1"></i> Connected
                                </span>
                                <span class="text-sm text-gray-500">Last checked: {{ vrchat_api_status.last_check|default('Never') }}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="mb-4">
                            <span class="block text-sm font-medium text-gray-700 mb-1">Database Status</span>
                            <div class="flex items-center">
                                <span class="badge badge-success mr-2">
                                    <i class="fas fa-check-circle mr-1"></i> Healthy
                                </span>
                                <span class="text-sm text-gray-500">{{ stats.db_type|default('PostgreSQL') }}</span>
                            </div>
                        </div>
                        <div class="mb-4">
                            <span class="block text-sm font-medium text-gray-700 mb-1">Memory Usage</span>
                            <div class="flex items-center">
                                <span class="badge badge-info mr-2">
                                    <i class="fas fa-memory mr-1"></i> {{ stats.memory_usage|default('0%') }}
                                </span>
                                <div class="w-48 bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ stats.memory_usage|default('0%') }}"></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-gray-700 mb-1">Web Dashboard Status</span>
                            <div class="flex items-center">
                                <span class="badge badge-success mr-2">
                                    <i class="fas fa-check-circle mr-1"></i> Online
                                </span>
                                <span class="text-sm text-gray-500">{{ stats.web_uptime|default('24h uptime') }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Servers Tab -->
    <div id="servers" class="tab-content">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-700">Managed Discord Servers</h2>
            <a href="/force-refresh-guilds" class="bg-discord hover:bg-blue-600 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                <i class="fas fa-sync-alt mr-2"></i> Refresh Servers
            </a>
        </div>

        <!-- Server Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for guild in guilds %}
            <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                <div class="bg-discord-dark p-4 flex items-center">
                    {% if guild.icon %}
                    <img src="https://cdn.discordapp.com/icons/{{ guild.id }}/{{ guild.icon }}.png" alt="{{ guild.name }}" class="w-12 h-12 rounded-full mr-4">
                    {% else %}
                    <div class="w-12 h-12 rounded-full bg-gray-500 flex items-center justify-center text-white font-bold mr-4">
                        {{ guild.name[:1] }}
                    </div>
                    {% endif %}
                    <div>
                        <h2 class="text-white text-xl font-bold">{{ guild.name }}</h2>
                        <div class="flex mt-1">
                            {% if guild.is_using_bot %}
                            <span class="bg-green-500 text-white text-xs px-2 py-1 rounded mr-2">
                                <i class="fas fa-check mr-1"></i> Bot Added
                            </span>
                            {% else %}
                            <span class="bg-gray-500 text-white text-xs px-2 py-1 rounded mr-2">
                                <i class="fas fa-times mr-1"></i> Bot Not Added
                            </span>
                            {% endif %}
                            
                            {% if guild.has_configured %}
                            <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded">
                                <i class="fas fa-cog mr-1"></i> Configured
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="p-4">
                    {% if guild.is_using_bot %}
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-500">Worlds</div>
                            <div class="font-bold">{{ guild.world_count|default('0') }}</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-500">Members</div>
                            <div class="font-bold">{{ guild.member_count|default('0') }}</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-500">Tags</div>
                            <div class="font-bold">{{ guild.tag_count|default('0') }}</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-500">Last Activity</div>
                            <div class="font-bold text-xs">{{ guild.last_activity|default('Never') }}</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <a href="/guild/{{ guild.id }}" class="bg-discord hover:bg-blue-600 text-white font-bold py-2 px-4 rounded flex-1 inline-flex items-center justify-center">
                            <i class="fas fa-cog mr-2"></i>
                            <span>Manage</span>
                        </a>
                        
                        <a href="https://discord.com/channels/{{ guild.id }}" target="_blank" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded inline-flex items-center justify-center">
                            <i class="fab fa-discord"></i>
                        </a>
                    </div>
                    {% else %}
                    <div class="text-center py-2 mb-4">
                        <p class="text-gray-600 mb-4">The bot is not in this server yet.</p>
                        <a href="{{ bot_invite_url }}&guild_id={{ guild.id }}" target="_blank" class="bg-discord hover:bg-blue-600 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center w-full">
                            <i class="fas fa-plus mr-2"></i>
                            <span>Add Bot to Server</span>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="col-span-full bg-white rounded-lg shadow-md p-6 text-center">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">No servers found</h2>
                <p class="text-gray-600 mb-4">You don't have admin permissions on any Discord servers or we couldn't fetch your servers.</p>
                <p class="text-gray-500">Make sure you have the "Administrator" permission on at least one server.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Worlds Tab -->
    <div id="worlds" class="tab-content">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 sm:mb-0">VRChat Worlds Database</h2>
            <div class="w-full sm:w-auto flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <div class="relative">
                    <input type="text" id="searchWorlds" placeholder="Search worlds..." class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-discord focus:border-transparent pl-10">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
                <select id="serverFilter" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-discord focus:border-transparent">
                    <option value="">All Servers</option>
                    {% for guild in guilds %}
                    {% if guild.is_using_bot %}
                    <option value="{{ guild.id }}">{{ guild.name }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Worlds Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">World</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Server</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Posted By</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Added</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for world in worlds|default([]) %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="h-10 w-10 bg-gray-200 rounded flex items-center justify-center mr-3">
                                        <i class="fas fa-globe text-gray-500"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ world.name|default('Unknown') }}</div>
                                        <div class="text-xs text-gray-500">{{ world.author|default('Unknown Author') }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900 font-mono">{{ world.world_id }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ world.guild.name }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ world.user_name|default('Unknown') }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ world.created_at }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="{{ world.world_link }}" target="_blank" class="text-discord hover:text-blue-700 mr-3">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                                <a href="https://discord.com/channels/{{ world.guild.id }}/{{ world.thread_id }}" target="_blank" class="text-gray-600 hover:text-gray-900 mr-3">
                                    <i class="fab fa-discord"></i>
                                </a>
                                <button class="text-red-600 hover:text-red-900" onclick="confirmDeleteWorld('{{ world.world_id }}', '{{ world.guild.id }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                No worlds found in the database
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if worlds|default([])|length > 0 %}
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-medium">1</span> to <span class="font-medium">{{ worlds|default([])|length }}</span> of <span class="font-medium">{{ total_worlds|default(worlds|default([])|length) }}</span> worlds
                </div>
                <div class="flex-1 flex justify-center sm:justify-end">
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-discord text-sm font-medium text-white hover:bg-blue-600">
                            1
                        </a>
                        <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            2
                        </a>
                        <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            3
                        </a>
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </nav>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Logs Tab -->
    <div id="logs" class="tab-content">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 sm:mb-0">Activity Logs</h2>
            <div class="w-full sm:w-auto flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <select id="logTypeFilter" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-discord focus:border-transparent">
                    <option value="">All Activity Types</option>
                    <option value="world_create">World Create</option>
                    <option value="world_remove">World Remove</option>
                    <option value="set_forum">Forum Configuration</option>
                    <option value="clean_db">Database Cleanup</option>
                    <option value="tag_update">Tag Update</option>
                </select>
                <select id="logServerFilter" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-discord focus:border-transparent">
                    <option value="">All Servers</option>
                    {% for guild in guilds %}
                    {% if guild.is_using_bot %}
                    <option value="{{ guild.id }}">{{ guild.name }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Activity Log Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Server</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for log in activity_logs|default([]) %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    {% if log.guild.icon %}
                                    <img class="h-8 w-8 rounded-full mr-2" src="https://cdn.discordapp.com/icons/{{ log.guild.id }}/{{ log.guild.icon }}.png" alt="{{ log.guild.name }}">
                                    {% else %}
                                    <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center mr-2">
                                        <span class="text-gray-600 font-bold">{{ log.guild.name[:1] }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="text-sm font-medium text-gray-900">{{ log.guild.name }}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if log.action_type == 'world_create' %}
                                <span class="badge badge-success">
                                    <i class="fas fa-plus-circle mr-1"></i> World Create
                                </span>
                                {% elif log.action_type == 'world_remove' %}
                                <span class="badge badge-danger">
                                    <i class="fas fa-trash mr-1"></i> World Remove
                                </span>
                                {% elif log.action_type == 'set_forum' %}
                                <span class="badge badge-info">
                                    <i class="fas fa-cog mr-1"></i> Forum Config
                                </span>
                                {% elif log.action_type == 'clean_db' %}
                                <span class="badge badge-info">
                                    <i class="fas fa-broom mr-1"></i> DB Cleanup
                                </span>
                                {% elif log.action_type == 'tag_update' %}
                                <span class="badge badge-info">
                                    <i class="fas fa-tags mr-1"></i> Tag Update
                                </span>
                                {% else %}
                                <span class="badge badge-info">
                                    <i class="fas fa-info-circle mr-1"></i> {{ log.action_type }}
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-900">{{ log.details }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ log.timestamp }}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                                No activity logs found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if activity_logs|default([])|length > 0 %}
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-medium">1</span> to <span class="font-medium">{{ activity_logs|default([])|length }}</span> of <span class="font-medium">{{ total_logs|default(activity_logs|default([])|length) }}</span> entries
                </div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Previous</span>
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-discord text-sm font-medium text-white hover:bg-blue-600">
                        1
                    </a>
                    <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                        2
                    </a>
                    <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                        3
                    </a>
                    <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                        ...
                    </span>
                    <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Next</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
        <h2 class="text-2xl font-bold text-gray-700 mb-6">Admin Settings</h2>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-700 mb-4">API Settings</h3>
            <form id="apiSettingsForm">
                <div class="mb-4">
                    <label for="vrchatAuthToken" class="block text-sm font-medium text-gray-700 mb-1">VRChat Auth Token</label>
                    <div class="flex">
                        <input type="password" id="vrchatAuthToken" value="{{ vrchat_auth }}" class="flex-grow px-4 py-2 border rounded-l focus:outline-none focus:ring-2 focus:ring-discord focus:border-transparent">
                        <button type="button" id="showAuthToken" class="bg-gray-200 px-4 border-t border-r border-b rounded-r">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Auth token used for VRChat API requests</p>
                </div>

                <div class="mb-4">
                    <label for="botIntents" class="block text-sm font-medium text-gray-700 mb-1">Discord Bot Intents</label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="intentGuilds" class="rounded text-discord focus:ring-discord mr-2" checked disabled>
                            <label for="intentGuilds" class="text-sm text-gray-700">Guilds (required)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="intentGuildMembers" class="rounded text-discord focus:ring-discord mr-2" checked>
                            <label for="intentGuildMembers" class="text-sm text-gray-700">Guild Members</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="intentMessageContent" class="rounded text-discord focus:ring-discord mr-2" checked>
                            <label for="intentMessageContent" class="text-sm text-gray-700">Message Content</label>
                        </div>
                    </div>
                </div>

                <div class="border-t pt-4 flex justify-end">
                    <button type="submit" class="bg-discord hover:bg-blue-600 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                        <i class="fas fa-save mr-2"></i> Save API Settings
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-700 mb-4">Maintenance</h3>
            
            <div class="space-y-4">
                <div class="p-4 border rounded-lg">
                    <h4 class="font-bold">Database Backup</h4>
                    <p class="text-gray-600 mb-3">Create a backup of your database. This includes all server configurations, world posts, and tags.</p>
                    <button id="backupDatabase" class="bg-discord hover:bg-blue-600 text-white py-2 px-4 rounded inline-flex items-center">
                        <i class="fas fa-database mr-2"></i> Backup Database
                    </button>
                </div>
                
                <div class="p-4 border rounded-lg">
                    <h4 class="font-bold">Clean Inactive Servers</h4>
                    <p class="text-gray-600 mb-3">Remove data for servers where the bot is no longer present or inactive for more than 30 days.</p>
                    <button id="cleanInactiveBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded inline-flex items-center">
                        <i class="fas fa-broom mr-2"></i> Clean Inactive Servers
                    </button>
                </div>
                
                <div class="p-4 border border-red-300 rounded-lg">
                    <h4 class="font-bold text-red-600">Danger Zone</h4>
                    <p class="text-gray-600 mb-3">These actions are permanent and cannot be undone.</p>
                    <div class="space-y-2">
                        <button id="resetAllBtn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded inline-flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i> Reset All Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
        <h3 class="text-lg font-bold mb-4">Confirm Deletion</h3>
        <p class="mb-6">Are you sure you want to delete this world? This action cannot be undone.</p>
        <div class="flex justify-end space-x-4">
            <button id="cancelDelete" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">Cancel</button>
            <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Delete</button>
        </div>
        <input type="hidden" id="deleteWorldId">
        <input type="hidden" id="deleteGuildId">
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab Switching
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('border-discord');
                btn.classList.remove('text-discord-dark');
                btn.classList.add('text-gray-600');
            });
            
            // Add active class to clicked button
            button.classList.add('border-discord');
            button.classList.add('text-discord-dark');
            button.classList.remove('text-gray-600');
            
            // Hide all tab contents
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Show the target tab content
            const tabId = button.dataset.tab;
            document.getElementById(tabId).classList.add('active');
            
            // Update the URL hash
            window.location.hash = tabId;
        });
    });
    
    // Check for URL hash on page load
    if (window.location.hash) {
        const tabId = window.location.hash.substring(1);
        const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
        if (tabButton) {
            tabButton.click();
        }
    }
    
    // Show/Hide Auth Token
    const showAuthTokenBtn = document.getElementById('showAuthToken');
    if (showAuthTokenBtn) {
        showAuthTokenBtn.addEventListener('click', function() {
            const authTokenInput = document.getElementById('vrchatAuthToken');
            if (authTokenInput.type === "password") {
                authTokenInput.type = "text";
                showAuthTokenBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                authTokenInput.type = "password";
                showAuthTokenBtn.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });
    }
    
    // API Settings Form
    const apiSettingsForm = document.getElementById('apiSettingsForm');
    if (apiSettingsForm) {
        apiSettingsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const vrchatAuthToken = document.getElementById('vrchatAuthToken').value;
            const intentGuildMembers = document.getElementById('intentGuildMembers').checked;
            const intentMessageContent = document.getElementById('intentMessageContent').checked;
            
            fetch('/api/admin/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    vrchat_auth: vrchatAuthToken,
                    intent_guild_members: intentGuildMembers,
                    intent_message_content: intentMessageContent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Settings saved successfully.');
                } else {
                    alert('Error: ' + (data.message || 'Failed to save settings.'));
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        });
    }
    
    // World Search
    const searchWorlds = document.getElementById('searchWorlds');
    const serverFilter = document.getElementById('serverFilter');
    if (searchWorlds && serverFilter) {
        const handleFilter = () => {
            const searchValue = searchWorlds.value.toLowerCase();
            const serverValue = serverFilter.value;
            
            const worldRows = document.querySelectorAll('#worlds tbody tr');
            
            worldRows.forEach(row => {
                let matches = true;
                
                // Check search value
                if (searchValue) {
                    const worldName = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
                    const worldId = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                    if (!worldName.includes(searchValue) && !worldId.includes(searchValue)) {
                        matches = false;
                    }
                }
                
                // Check server filter
                if (serverValue && matches) {
                    const serverName = row.querySelector('td:nth-child(3)')?.getAttribute('data-server-id') || '';
                    if (serverName !== serverValue) {
                        matches = false;
                    }
                }
                
                // Show/hide row
                row.style.display = matches ? '' : 'none';
            });
        };
        
        searchWorlds.addEventListener('input', handleFilter);
        serverFilter.addEventListener('change', handleFilter);
    }
    
    // Log Filters
    const logTypeFilter = document.getElementById('logTypeFilter');
    const logServerFilter = document.getElementById('logServerFilter');
    if (logTypeFilter && logServerFilter) {
        const handleLogFilter = () => {
            const typeValue = logTypeFilter.value;
            const serverValue = logServerFilter.value;
            
            const logRows = document.querySelectorAll('#logs tbody tr');
            
            logRows.forEach(row => {
                let matches = true;
                
                // Check type filter
                if (typeValue) {
                    const logType = row.querySelector('td:nth-child(2) span')?.getAttribute('data-type') || '';
                    if (logType !== typeValue) {
                        matches = false;
                    }
                }
                
                // Check server filter
                if (serverValue && matches) {
                    const serverId = row.querySelector('td:nth-child(1)')?.getAttribute('data-server-id') || '';
                    if (serverId !== serverValue) {
                        matches = false;
                    }
                }
                
                // Show/hide row
                row.style.display = matches ? '' : 'none';
            });
        };
        
        logTypeFilter.addEventListener('change', handleLogFilter);
        logServerFilter.addEventListener('change', handleLogFilter);
    }
    
    // World Deletion
    window.confirmDeleteWorld = function(worldId, guildId) {
        const deleteModal = document.getElementById('deleteModal');
        const deleteWorldId = document.getElementById('deleteWorldId');
        const deleteGuildId = document.getElementById('deleteGuildId');
        
        deleteWorldId.value = worldId;
        deleteGuildId.value = guildId;
        
        deleteModal.classList.remove('hidden');
    };
    
    const cancelDelete = document.getElementById('cancelDelete');
    const confirmDelete = document.getElementById('confirmDelete');
    const deleteModal = document.getElementById('deleteModal');
    
    if (cancelDelete) {
        cancelDelete.addEventListener('click', function() {
            deleteModal.classList.add('hidden');
        });
    }
    
    if (confirmDelete) {
        confirmDelete.addEventListener('click', function() {
            const worldId = document.getElementById('deleteWorldId').value;
            const guildId = document.getElementById('deleteGuildId').value;
            
            fetch(`/api/guild/${guildId}/world/${worldId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete world.'));
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            })
            .finally(() => {
                deleteModal.classList.add('hidden');
            });
        });
    }
    
    // Maintenance Buttons
    const backupDatabase = document.getElementById('backupDatabase');
    if (backupDatabase) {
        backupDatabase.addEventListener('click', function() {
            if (confirm('Create a database backup?')) {
                window.location.href = '/api/admin/backup';
            }
        });
    }
    
    const cleanInactiveBtn = document.getElementById('cleanInactiveBtn');
    if (cleanInactiveBtn) {
        cleanInactiveBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clean inactive servers? This will remove all data for servers where the bot is no longer present or has been inactive for more than 30 days.')) {
                fetch('/api/admin/clean-inactive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Cleaned ' + data.cleaned + ' inactive servers.');
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.message || 'Failed to clean inactive servers.'));
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
            }
        });
    }
    
    const resetAllBtn = document.getElementById('resetAllBtn');
    if (resetAllBtn) {
        resetAllBtn.addEventListener('click', function() {
            if (confirm(' WARNING: This will reset ALL configurations and data. This action CANNOT be undone. Are you absolutely sure?')) {
                if (prompt('Type "RESET ALL" to confirm:') === 'RESET ALL') {
                    fetch('/api/admin/reset-all', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('All configurations and data have been reset.');
                            window.location.href = '/dashboard';
                        } else {
                            alert('Error: ' + (data.message || 'Failed to reset configurations.'));
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
                }
            }
        });
    }
    
    // Close modal when clicking outside
    deleteModal.addEventListener('click', function(e) {
        if (e.target === deleteModal) {
            deleteModal.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}